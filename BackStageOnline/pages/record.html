<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>海蜂后台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="renderer" content="webkit" />

    <link rel="stylesheet" href="../style/normalize.css">
    <link rel="stylesheet" href="../style/main.css">
    <script src="../js/jquery.min.js"></script>
    <script src="../js/common.js"></script>

    <script src="../plugin/fileupload/vendor/jquery.ui.widget.js"></script>
    <script src="../plugin/fileupload/jquery.iframe-transport.js"></script>
    <!-- <script src="../plugin/fileupload/jquery.fileupload-process.js"></script>
-->
<script src="../plugin/fileupload/jquery.fileupload.js"></script>
</head>
<body>
<div class="content-panel">
    <div class="panel-top">
        <h3>档案管理</h3>
    </div>
    <div class="infor clearfix">
        <div class="portrait fl">
            <div class="img">
                <img src="../images/male.png" id="upLoadImg"></div>
            <div class="inport">
                <p>
                    <input id="fileupload" type="file" name="files[]" data-url="server/php/">
                    <span>点击上传</span>
                </p>
            </div>
        </div>
        <div class="base-infor clearfix fl">
            <ul class="infor-menu">
                <li>
                    <label class="rt default-label">商家名称</label>
                    <input class="default-input" type="text" placeholder="请输入商家名称"></li>
                <li>
                    <label class="rt default-label">联系人</label>
                    <input class="default-input" type="text" placeholder="请输入联系人姓名"></li>
                <li>
                    <label class="rt default-label">联系电话</label>
                    <input class="default-input" type="text" placeholder="请输入联系人电话"></li>
                <li>
                    <label class="rt default-label">联系地址</label>
                    <input class="default-input lg-input" type="text" placeholder="请输入联系人地址"></li>
                <li class="textareali">
                    <label class="rt default-label">商家介绍</label>
                    <textarea class="lg-input" rows="3" placeholder="可介绍的品牌、门店、服务等(限定50个字)"></textarea>
                </li>
            </ul>
        </div>
    </div>
    <div class="hire-infor">
        <ul class="infor-menu hire-menu">
            <li>
                <label class="rt default-label">所属行业</label>
                <select class="default-select">
                    <option option="option1">餐饮</option>
                    <option option="option2">餐饮</option>
                    <option option="option3">餐饮</option>
                    <option option="option4">餐饮</option>
                </select>
            </li>
            <li>
                <label class="rt default-label">招聘岗位地点</label>
                <select class="default-select">
                    <option option="option1">杭州</option>
                    <option option="option2">宁波</option>
                    <option option="option3">绍兴</option>
                </select>
                <input class="default-input lg-input" type="text" placeholder="请输入具体位置，如银泰城"></li>
            <li>
                <label class="rt default-label">招聘岗位范围</label>
            </li>
            <li class="hirepost">
                <a href="javascript:void(0);" class="hiretype choosemark" onclick="addMark($(this))">
                    <!-- <input type="checkbox">
                    迎宾 -->
                        迎宾
                </a>
                <a href="javascript:void(0);" class="hiretype" onclick="addMark($(this))">
                    <!-- <input type="checkbox">
                    迎宾 -->
                        迎宾
                </a>
            </li>
        </ul>
        <p class="btnp">
            <button type="button" class="editbtn">修改</button>
            <a href="hunt.html" class="confirm-link">确认，马上找人</a>
        </p>
        <!-- <p class="btnp">
        <button type="button" class="editbtn">修改</button>
        <button type="button">确认，马上找人</button>
    </p>
    -->
</div>
</div>
<script src="../js/fixdiv.js"></script>
<script src="../js/address.js"></script>
<script type="text/javascript">
        $(function () {
            // $(".hiretype").click(function(){
            //     $(this).toggleClass("choosemark");
            // });
            // 上传图片
            $('#fileupload').fileupload({
                dataType: 'json',
                add: function (e, data) {
                    // data.context = $('<p/>').text('Uploading...').appendTo(document.body);
                    $("#upLoadImg").attr({ src: data.result.imgurl });
                    // $("#upLoadImg").css({width:"290px",height:"218px"});
                    //alert(data.result);
                },
                progressall: function (e, data) { //设置上传进度事件的回调函数
                    var progress = parseInt(data.loaded / data.total * 5, 10);
                    $('#progress .bar').css(
                        'width',
                        progress + '%'
                    );
                }
            });

            //获取登录用户的手机号码
            var oUserInfo = window.parent.oUserInfo;
            if (oUserInfo !== null) {

                //初始化地图
                var map = new AMap.Map("container", {
                    resizeEnable: true
                });
                //为地图注册click事件获取鼠标点击出的经纬度坐标
                //var clickEventListener = map.on('click', function (e) {
                //    document.getElementById("lnglat").value = e.lnglat.getLng() + ',' + e.lnglat.getLat();
                //});
                var auto = new AMap.Autocomplete({
                    input: "txtLocation"
                });
                AMap.event.addListener(auto, "select", select); //注册监听，当选中某条记录时会触发
                function select(e) {
                    if (e.poi && e.poi.location) {
                        //map.setZoom(15);
                        //map.setCenter(e.poi.location);
                    }
                    //经纬度获取
                    $("#txtLocation").val(e.poi.name);
                    $("#hidLng").val(e.poi.location.lng);
                    $("#hidLat").val(e.poi.location.lat);
                }

                var oIndustryPosition;
                //获取行业数据
                //$.post('/Ajax/Common/Common.ashx', { action: 'GetIndustryPositions' }, function (resp) {
                //    if (resp.code === "1000") {
                //绑定行业岗位信息
                //oIndustryPosition = resp.data;
                oIndustryPosition = window.parent.oIndustryAndPosition;
                if (oIndustryPosition.Industrys !== null && oIndustryPosition.Industrys !== "") {
                    $.each(oIndustryPosition.Industrys, function (n, value) {
                        $("#selIndustry").append("<option value='" + value.Id + "'>" + value.IndustryName + "</option>");
                    });

                    $("#txtMerchantName").val(oUserInfo.AccountName);
                    $("#txtContact").val(oUserInfo.Contact);
                    $("#txtMobile").val(oUserInfo.Mobile);
                    $("#txtAddress").val(oUserInfo.Address);
                    $("#txtRemark").val(oUserInfo.Remark);
                    $("#txtLocation").val(oUserInfo.Location);
                    $("#hidLng").val(oUserInfo.Longitude);
                    $("#hidLat").val(oUserInfo.Latitude);

                    $("#selIndustry").find("option[value='" + oUserInfo.Industry + "']").attr("selected", true);
                    var oPositions = $.grep(oIndustryPosition.Positions, function (item) {
                        return item.IndustryId === parseInt(oUserInfo.Industry);
                    });
                    if (oPositions !== null) {
                        var sPositionHtml = '';
                        $.each(oPositions, function (n, value) {
                            if (oUserInfo.Position.indexOf(value.Id) !== -1)
                                sPositionHtml += '<a href="javascript:void(0);" class="hiretype choosemark" data-id="' + value.Id + '" onclick="addMark($(this))">' + value.PositionName + '</a>';
                            else
                                sPositionHtml += '<a href="javascript:void(0);" class="hiretype" data-id="' + value.Id + '" onclick="addMark($(this))">' + value.PositionName + '</a>';
                        });
                        $("#liPositions").html(sPositionHtml);
                    }
                    //选择行业
                    $("#selIndustry").change(function () {
                        var txtIndustry = $(this).val();
                        var oCurPositions = $.grep(oIndustryPosition.Positions, function (item) {
                            return item.IndustryId === parseInt(txtIndustry);
                        });
                        if (oCurPositions !== null) {
                            var sPositionHtml = '';
                            $.each(oCurPositions, function (n, value) {
                                sPositionHtml += '<a href="javascript:void(0);" class="hiretype" data-id="' + value.Id + '" onclick="addMark($(this))">' + value.PositionName + '</a>';
                            });
                            $("#liPositions").html(sPositionHtml);
                        }
                    });
                    //保存
                    $(".editbtn").click(function () {
                        var txtMerchantName = $("#txtMerchantName").val();
                        var txtContact = $("#txtContact").val();
                        var txtMobile = $("#txtMobile").val();
                        var txtAddress = $("#txtAddress").val();
                        var txtRemark = $("#txtRemark").val();
                        var txtLocation = $("#txtLocation").val();
                        var txtIndustry = $("#selIndustry").val();
                        var oPositions = $("#liPositions a.choosemark");
                        var txtPositions = '';
                        $.each(oPositions, function (n, value) {
                            txtPositions += $(value).attr('data-id') + ',';
                        });

                        var txtLong = $("#hidLng").val();
                        var txtLat = $("#hidLat").val();

                        if (txtMerchantName === "") {
                            alert('商户名称不能为空');
                            return false;
                        }
                        if (txtContact === "") {
                            alert('联系人不能为空');
                            return false;
                        }
                        if (txtMobile === "" || txtMobile.length !== 11) {
                            alert('手机号码不合法');
                            return false;
                        }
                        if (txtAddress === "") {
                            alert('联系地址不能为空');
                            return false;
                        }
                        if (txtRemark.length > 200) {
                            alert('描述信息过长');
                            return false;
                        }
                        if (txtIndustry === "") {
                            alert('行业不能为空');
                            return false;
                        }
                        if (txtPositions === "") {
                            alert('岗位不能为空');
                            return false;
                        }

                        txtPositions = txtPositions.substr(0, txtPositions.length - 1);

                        if (txtLocation === "" || txtLong === "" || txtLat === "") {
                            alert('招聘岗位地点不合法');
                            return false;
                        }

                        $.post('/Ajax/MerchantSetting/ArchivesManagement.ashx', {
                            action: 'ModifyMerchantInfo',
                            data: "{\"accountid\":\"" + oUserInfo.Id + "\",\"accountname\":\"" + txtMerchantName + "\"," +
                                "\"contact\":\"" + txtContact + "\",\"mobile\":\"" + txtMobile + "\",\"address\":\"" + txtAddress + "\",\"industry\":\"" + txtIndustry + "\"," +
                                "\"positions\":\"" + txtPositions + "\",\"location\":\"" + txtLocation + "\",\"lng\":\"" + txtLong + "\",\"lat\":\"" + txtLat + "\",\"remark\":\"" + txtRemark + "\"}"
                        }, function (resp) {
                            if (resp.code === "1000") {
                                //修改成功，更新登录实体
                                window.parent.oUserInfo.AccountName = txtMerchantName;
                                window.parent.oUserInfo.Contact = txtContact;
                                window.parent.oUserInfo.Mobile = txtMobile;
                                window.parent.oUserInfo.Address = txtAddress;
                                window.parent.oUserInfo.Remark = txtRemark;
                                window.parent.oUserInfo.Location = txtLocation;
                                window.parent.oUserInfo.Industry = parseInt(txtIndustry);
                                window.parent.oUserInfo.Position = txtPositions;
                                window.parent.oUserInfo.Longitude = txtLong;
                                window.parent.oUserInfo.Latitude = txtLat;

                                alert('修改成功');
                                $(".editbtn").hide().next("a").css("display", "inline-block");
                            } else {
                                alert('错误代码：' + resp.code + '；错误信息：' + resp.msg);
                            }
                        });
                        return true;
                    });
                }
                //    } else {
                //        alert('错误代码：' + resp.code + '；错误信息：' + resp.msg);
                //    }
                //});
            } else {
                alert('登录失效');
                window.location.href = 'index.html';
            }

        });

    </script>
</body>
</html>